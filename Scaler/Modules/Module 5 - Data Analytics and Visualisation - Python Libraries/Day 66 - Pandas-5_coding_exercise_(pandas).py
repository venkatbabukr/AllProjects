# -*- coding: utf-8 -*-
"""Coding Exercise (Pandas).ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1yn1OGCBJJQJp1sIljkmJwdf0uySIJUhO

# Coding Exercise (Pandas)

---
"""

!pip install --upgrade gdown

"""Loading the dataset -"""

!gdown 1s2TkjSpzNc4SyxqRrQleZyDIHlc7bxnd
!gdown 1Ws-_s1fHZ9nHfGLVUQurbHDvStePlEJm

import pandas as pd
import numpy as np

movies = pd.read_csv('movies.csv', index_col=0)
directors = pd.read_csv('directors.csv', index_col=0)

movies.head()

directors.head()

"""---

### Q1 - How many years of data is given to you in the `movies` dataset?
"""

no_of_years = movies["year"].max() - movies["year"].min()
print(no_of_years)

"""---

### Q2 - Display the `ReleaseDate` in the Day-Month-Year format.
"""

releaseDate = movies["day"] + "-" + movies["month"] + "-" + movies["year"]
print(releaseDate[:5])

# confirm the error by checking the datatypes of the columns
movies.info()

"""As year is in `int` format, we need to typecast it before concatenation.

We'll use the `astype()` function here for typecasting.
"""

releaseDate = movies["day"] + "-" + movies["month"] + "-" + movies["year"].astype("str")
print(releaseDate[:5])

"""---

### Q3 - What is the % of male directors in the given data?
"""

directors["gender"].value_counts()

directors["gender"].value_counts(normalize=True)

directors["gender"].value_counts(normalize=True)*100

"""More than 91% of the directors in the dataset are Male.

---

### Q4 - How many different movies have been directed in the year 2010?
"""

movies2010 = movies[movies["year"]==2010]

len(movies2010) # as every row is a unique movie

movies2010["id"].nunique()

"""---

### Q5 - How many different directors have directed a movie since 2010 (inclusive)?
"""

sample = movies[movies["year"] >= 2010]
sample["director_id"].nunique()

"""---

### Q6 - What are the names of those directors?
"""

ids = sample["director_id"].unique()
print(ids[:5])

names = directors[directors["id"].isin(ids)]["director_name"]
print(names)

names.count() # validating

"""---

### Q7 - Display the name of the director who directed the Spider-Man 3 movie.
"""

# Approach 1: without using merge

df = movies[movies["title"] == "Spider-Man 3"]
df

director_id = df["director_id"]
director_id

director_id.reset_index(drop=True, inplace=True)
director_id

id = director_id[0]

name = directors.loc[directors["id"] == id, "director_name" ]
print(name)

# Approach 2: first merge and then filter row

data = movies.merge(directors, how='inner', left_on='director_id',right_on='id')
data.drop(['director_id','id_y'], axis=1, inplace=True)

data.head()

name = data[data["title"] == "Spider-Man 3"]["director_name"]
print(name)

"""---

### Q8 - How many different movies have been directed by James Cameron between year 2005 to 2010?
"""

directors.head()

james_id = directors.loc[directors['director_name'] == "James Cameron"]
james_id

james_id = directors.loc[directors['director_name'] == "James Cameron"].reset_index(drop = True)["id"][0]
james_id

movies.head()

james_movies = movies.loc[(movies["director_id"] == james_id) & (movies["year"] >= 2000) & (movies["year"] <= 2015)]
james_movies

"""Let us write a function to do the exact same thing for whichever director we want."""

def solve(director_name, start_year, end_year):

  director_id = directors.loc[ directors['director_name'] == director_name].reset_index(drop = True)["id"][0]

  director_movies = movies.loc[(movies["director_id"] == director_id)]

  df = director_movies.loc[ (director_movies["year"] >= start_year) & (director_movies["year"] <= end_year) ]

  return df

solve("James Cameron", 2000, 2015)

solve("Gore Verbinski", 2000, 2015)

solve("Aditya Jain", 2000, 2015)

"""We get an error whenever the passed director name is not present in the dataset.

From the industry's perspective, we try to make our function robust to such conditions.
"""

def solve(director_name, start_year, end_year):

  df = directors[directors["director_name"] == director_name]

  if len(df) != 0:
    director_id = directors.loc[ directors['director_name'] == director_name].reset_index(drop = True)["id"][0]
    director_movies = movies.loc[(movies["director_id"] == director_id)]
    df = director_movies.loc[ (director_movies["year"] >= start_year) & (director_movies["year"] <= end_year) ]
    return df

  else:
    return "No movies directed!"

solve("Aditya Jain", 2000, 2015)

"""---

### Q9 - Among the top 10 most popular movies, which is the movie with the 2nd highest vote_avg?
"""

top_popular_movies = movies.sort_values("popularity", ascending=False)
top_10_popular = top_popular_movies.head(10)
top_10_popular

top_voted = top_10_popular.sort_values("vote_average", ascending=False)
top_voted

ans = top_voted.iloc[[1]]
ans

"""---

### Quiz: Is the below code doing the same thing?
"""

top_popular_movies = movies.sort_values(["popularity", "vote_average"], ascending=[False, False]).head(10).iloc[[1]]
top_popular_movies

"""---

### Q10 - How many movies that are among top 10 popular movies are also among top 10 rated (vote_avg)?
"""

# Get the top 10 popular movies

top_10_popular_movies = movies.sort_values("popularity", ascending=False)["title"].head(10)
top_10_popular_movies

# Get the top 10 rated movies

top_10_rated_movies = movies.sort_values("vote_average", ascending=False)["title"].head(10)
top_10_rated_movies

df_popularly_rated = movies[(movies["title"].isin(top_10_popular_movies)) & (movies["title"].isin(top_10_rated_movies))]
df_popularly_rated

"""---

### Q11 - Create a new metric called `revenue_per_budget` i.e. revenue/budget and round it off up to 2 decimal places.
"""

def new_metric(df):
  val = np.round(df["revenue"]/df["budget"],2)
  df["revenue/budget"] = val
  return df

movies_copy = movies[["revenue", "budget"]].apply(new_metric, axis=1)
movies_copy.head()

movies_copy = movies[["revenue", "budget"]].apply(new_metric, axis=1)
movies_copy.head()

"""---

### Q12 - In which year did Christopher Nolan produced most number of movies?
"""

data = movies.merge(directors, how='left', left_on='director_id', right_on='id')
data.drop(['director_id','id_y'], axis=1, inplace=True)

chris_movies = data[data["director_name"] == "Christopher Nolan"]
print(chris_movies)

result = chris_movies.groupby("year")["title"].count()
result

"""Let's us write a function to do the exact same thing for whichever director we want."""

def year_wise_movies(director_name):

  dir_movies = data[data["director_name"] == director_name]

  result = dir_movies.groupby("year")["title"].count()

  return result

year_wise_movies('James Cameron')

# grouping data on multiple columns

data.groupby(["director_name","year"])["title"].count()

res = data.groupby(["director_name","year"])["title"].count()
res.sort_values(ascending = False)

data[["director_name", "year"]].value_counts() # one-liner logic

"""---

### Q13 - In which decade, the most number of movies were produced?
"""

data.describe()

"""To get an idea about the range of years we are dealing with.

We have data from 1976 to 2016 - let's create the decades accordingly.
"""

# Binning the years into decades -

bins = [1970, 1980, 1990, 2000, 2010, 2020]
labels = ["1", "2", "3", "4", "5"]

data["year_bucket"] = pd.cut(data["year"], bins = bins, labels = labels)
data

data["year_bucket"].value_counts()

"""Most number of movies were produced in between the years 2000 and 2010.

---

### Q14 - Within the decade with most number of movies, which were the top 5 contributing directors (who produced most)?
"""

data_4 = data[data["year_bucket"] == 4]
data["director_name"].value_counts().head()

# Check for missing values
data.isna().sum()

# Filling null values
data["gender"].fillna("NA", inplace = True)

data["gender"].value_counts(normalize=True)*100

"""### HW - Try to fill gender with M/F depending on the mode within each genre.

---

### Q15 - Display movie details of only those years where number of movies produced are more than 70.
"""

result = data.groupby("year").filter(lambda x: x["title"].count() > 70)
result

data["year"].value_counts()

"""Only year 2005 and 2006 had more than 70 movies, i.e. 71 and 73 respectively so total rows in the output should be 71+73 = 144"""

data[data["year"].isin([2005, 2006])]

"""---"""